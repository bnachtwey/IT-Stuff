#! /bin/bash
#! /bin/bash

# changelog
# date          version	 remark
# 2026-01-03    0.1		initial coding, script derived from my "deploy-DP.sh"
##############################################################################
#
#        deploy-MetaSploit2-PVE.sh
#        
#        script for deploying Metasploit2 VM on Proxmox
#
#  (C) 2026 		 Bjørn Nachtwey himself
#                    mailto:code@bjoernsoe.net
#   
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
##############################################################################


#############################################
############### FUNCTIONS USED ##############
#############################################

# check for needed tools
PVESM=""
QEMU_IMG=""
QM=""
JQ=""
RSYNC=""
SED=""
GREP=""

function findUtilPath()
{
    utilName=$1
    out_var=$2
    local util=$( which $utilName )
    if [[ "$?" != "0" || "$util" == "" ]]
	then
        missingUtils=$utilName" "$missingUtils
        return
    fi
    eval $out_var=$util
    return 0
}

function findUtils()
{
    findUtilPath 'pvesm' PVESM
	findUtilPath 'qemu-img' QEMU_IMG
    findUtilPath 'qm' QM
    findUtilPath 'jq' JQ
    findUtilPath 'rsync' RSYNC
    findUtilPath 'sed' SED
    findUtilPath 'grep' GREP

    if [[ "$missingUtils" != "" ]]
	then
        echo -e "Failed to find following utility/utilities.\n" \
            "Please install the appropriate package(s) and retry."
        for util in $missingUtils
		do
            echo -e "\t - $util"
        done
        exit 301
    fi

    echo -e "Using following utils:\n" \
        "\t pvesm        : $PVESM\n" \
		"\t qemu-img     : $QEMU_IMG\n" \
		"\t qm           : $QM\n" \
        "\t jq           : $JQ\n" \
        "\t rsync        : $RSYNC\n" \
        "\t sed          : $SED\n" \
        "\t grep         : $GREP\n"
}

###############################################
############### PREPARE ROLL-OUT ##############
###############################################
# Check if needed utilities are installed
findUtils


# Set basic VM infos
## Get highest already deployed VMs
NEXT_VMID=$(($(qm list | awk 'END{print $1}') + 1))

## Ask for VMID with suggesting the next number available
read -p "Enter VMID [${NEXT_VMID}]: " -e -i "${NEXT_VMID}" VMID
VMID="${VMID:-${NEXT_VMID}}"

## Ask for name with VMID-based suggestion
read -p "Enter VM name [VM${VMID}]: " -e -i "VM${VMID}" VMNAME
VMNAME="${VMNAME:-VM${VMID}}"

############### VIRTUAL RESSOURCES ###############

## Set Memory Size
echo ""
read -p "Enter memory in MB [512]: " -e -i "512" MEMORY_MB
MEMORY_MB="${MEMORY_MB:-32}"
MEMORY_SIZE=$(( MEMORY_MB ))

## Set Number of Processors (Sockets & Cores)
echo ""
read -p "Enter number of cores [1]: " -e -i "1" CORES
CORES="${CORES:-32}"

read -p "Enter number of sockets [1]: " -e -i "1" SOCKETS
SOCKETS="${CORES:-32}"

## Set CPU type, suggest type based on actual system
## get capability of actual CPU
if grep -qw 'avx512' /proc/cpuinfo; then
    CPU=x86-64-v4
elif grep -qw 'avx2' /proc/cpuinfo; then
    CPU=x86-64-v3
elif grep -qw 'avx' /proc/cpuinfo; then
    CPU=x86-64-v2
else
    CPU=x86-64-v1
fi

echo "Set CPU type"
echo "If you're using a proxmox cluster chose minimum requirements met by all nodes"
read -p "Enter CPUTYPE [${CPU}]: " -e -i "$CPU" CPUTYPE
CPUTYPE="${CPUTYPE:-${CPUTYPE}}"

# Network
echo ""
echo "Network settings:"
## Get active non-bridge interfaces
mapfile -t interfaces < <(
    ip -o link show | grep "state UP" |
    awk -F': ' '!/bridge|NO-CARRIER|fwbr|fwpr|tap/ && $2 != "lo" {print $2}'
)

## Check if any interfaces found
if [[ ${#interfaces[@]} -eq 0 ]]; then
    echo "No active network interfaces found" >&2
    exit 1
fi

## Create selection menu
PS3="Select network interface: "
select INTERFACE in "${interfaces[@]}"; do
    if [[ -n "$INTERFACE" ]]; then
        break
    else
        echo "Invalid selection" >&2
    fi
done

### Ask for fix MAC address
while :;
do
    echo "Enter fix MAC (hh:hh:hh:hh:hh:hh or hh-hh-hh-hh-hh-hh) or leave empty to skip and use dynamically assinged one:"
    read -r -p "=> " REPLY

    # user pressed Enter → leave MAC empty and continue script
    [ -z "$REPLY" ] && break

    # validate: 6 groups of 2 hex digits separated by : or -
    if [[ "$REPLY" =~ ^([0-9A-Fa-f]{2}[:-]){5}[0-9A-Fa-f]{2}$ ]]
    then
        # normalize: replace "-" with ":" and uppercase
        REPLY=${REPLY//-/:}
        MACADR=${REPLY^^}
        break
    else
        echo "Invalid format. Please use 6 hex byte pairs separated by ':' or '-'."
    fi
done

# Disk settings

## Get all storage pools eligable for "images"
echo
echo "Storage settings"
mapfile -t pools < <(pvesm status --content images | tail -n +2 | grep active | awk '{print $1}')

## Function to display selection menu for storage pools
select_pool() {
    local prompt="$1"
    PS3="$prompt: "
    select pool in "${pools[@]}" 
    do
        if [[ -n "$pool" ]]
        then
            echo "$pool"
            break
        else
            echo "Invalid selection" >&2
        fi
    done
}
OPOOL=$(select_pool "Choose storage pool for OS disk ")

## Get possible Sourcedisk
echo
read -p "Enter a path to look for disk images: " SRCDIR
mapfile -t SRCFILES < <(find "${SRCDIR}" -maxdepth 1 -type f \( -name "*.qcow2" -o -name "*.vmdk" -o -name "*.vdi" \) ) # qcow2, vmdk, vdi only
if [ ${#SRCFILES[@]} -eq 0 ]
then
    echo "Neither .qcow2 nor .vmkd or .vdi files found in ${SRCDIR}"
    exit 1
fi

echo "Image files found:"
PS3="Select image file: "
select OSRCDISK in "${SRCFILES[@]}"
do
    if [ -n "${OSRCDISK}" ]
    then
        echo "You selected: ${OSRCDISK}"
        break
    else
        echo "Invalid selection."
    fi
done

##################################################
################# GO & DO ROLLOUT#################
##################################################

## Create VM and attach given disk
qm create ${VMID} --name ${VMNAME}

## Setup Memory and CPUs
qm set ${VMID} --memory ${MEMORY_SIZE}
qm set ${VMID} --balloon ${MEMORY_SIZE}
qm set ${VMID} --cpu cputype=${CPUTYPE}
qm set ${VMID} --cores ${CORES} --sockets ${SOCKETS} --numa 1

## Network
if [ -z ${MACADR} ]
then
    qm set ${VMID} --net0 virtio,bridge=${INTERFACE}
else
    qm set ${VMID} --net0 virtio=${MACADR},bridge=${INTERFACE}
fi

## Enable QEMU agent
qm set ${VMID} --agent enabled=1
## Set OS Type to Linux 2.6 (or newer)
qm set ${VMID} --ostype l26

## prepare DISK settings
qm set ${VMID} --scsihw virtio-scsi-single
qm set ${VMID} --bios seabios

## import and assign OS DISK
ODISK=$(qm importdisk ${VMID} ${OSRCDISK}  ${OPOOL}| tail -n 1 | cut -d "'" -f 2)

qm set ${VMID} --sata0 ${ODISK}
qm set ${VMID} --boot order=sata0

# exit without error
exit 0;